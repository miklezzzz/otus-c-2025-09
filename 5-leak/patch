diff --git a/src/common/clib-package.c b/src/common/clib-package.c
index 268538e..b48ac05 100644
--- a/src/common/clib-package.c
+++ b/src/common/clib-package.c
@@ -657,6 +657,7 @@ clib_package_new_from_slug_with_package_name(const char *slug, int verbose,
 #ifdef HAVE_PTHREADS
       init_curl_share();
       _debug("GET %s", json_url);
+      http_get_free(res);
       res = http_get_shared(json_url, clib_package_curl_share);
 #else
       res = http_get(json_url);
@@ -996,10 +997,10 @@ cleanup:
 #ifdef HAVE_PTHREADS
 static void *fetch_package_file_thread(void *arg) {
   fetch_package_file_thread_data_t *data = arg;
-  int *status = malloc(sizeof(int));
+  // int *status = malloc(sizeof(int));
   int rc =
       fetch_package_file_work(data->pkg, data->dir, data->file, data->verbose);
-  *status = rc;
+  int status = rc;
   (void)data->pkg->refs--;
   pthread_exit((void *)status);
   return (void *)rc;
@@ -1380,7 +1381,9 @@ int clib_package_install(clib_package_t *pkg, const char *dir, int verbose) {
 #ifdef HAVE_PTHREADS
     pthread_mutex_lock(&lock.mutex);
 #endif
-    hash_set(visited_packages, strdup(pkg->name), "t");
+    if (!hash_has(visited_packages, pkg->name)) {
+      hash_set(visited_packages, strdup(pkg->name), "t");
+    }
 #ifdef HAVE_PTHREADS
     pthread_mutex_unlock(&lock.mutex);
 #endif
@@ -1695,5 +1698,8 @@ void clib_package_cleanup() {
 
     hash_free(visited_packages);
     visited_packages = 0;
+
   }
+
+  curl_share_cleanup(clib_package_curl_share);
 }
diff --git a/test/package/package-new-from-slug.c b/test/package/package-new-from-slug.c
index cd12455..f7b1044 100644
--- a/test/package/package-new-from-slug.c
+++ b/test/package/package-new-from-slug.c
@@ -1,11 +1,15 @@
-
-#include "describe/describe.h"
+#include "clib-cache.h"
 #include "clib-package.h"
+#include "describe/describe.h"
+#include "rimraf/rimraf.h"
 
 int
 main() {
   curl_global_init(CURL_GLOBAL_ALL);
 
+  clib_cache_init(100);
+  rimraf(clib_cache_dir());
+
   describe("clib_package_new_from_slug") {
     it("should return NULL when given a bad slug") {
       assert(NULL == clib_package_new_from_slug(NULL, 0));
@@ -70,5 +74,8 @@ main() {
     }
   }
 
+  curl_global_cleanup();
+  clib_package_cleanup();
+
   return assert_failures();
 }
